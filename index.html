<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>touchMe</title>
</head>
  <inherits>
    <link rel="stylesheet" href="style.css">
    <script src="pixi.min.js"></script></inherits>
  <script type="text/javascript" >
  //config
    //pixi config
        let type = "WebGL"
        let app = new PIXI.Application();
        basicText = new PIXI.Text("", {
          x: 30,
          y: 90,
          fill: "white"
        });
      
      if(!PIXI.utils.isWebGLSupported()){
        type = "canvas"
      }
    //

    //Orientation
      function renderPortrait (){
          app.renderer.autoresize = true;
          app.renderer.view.style.position = "absolute";
          app.renderer.view.style.display = "block";
          app.renderer.resize(window.innerWidth, window.innerHeight);
          document.body.appendChild(app.view);        
          app.stage.addChild(basicText);
      }
    //

    //debug
      function showMe(string){
        basicText.setText(string);
      }
    //

    //monitoring
      //looking for 16.6666ms
      var gameStart;
      var frameStartTime;
      var frameElapsedTime;
      function loadPerformanceGlobals(){
        gameStart = performance.now();
        frameStartTime = gameStart;
      }

      function frameRate(){
        frameElapsedTime = performance.now() - frameStartTime;
        var output = frameElapsedTime;
        frameStartTime = performance.now();
        return output;
      }
    //

    //settings
      function loadGlobals(){
        loadPerformanceGlobals();
      }
    //
  //

  //objects

    //controls
      //touching
        var touchStartPosition = {
          x: 0,
          y: 0
        };
        var touchLength = 0;
        var isTouching = false;
        var touchFrames = 0;
        function touchStart(e){
          touchStartPosition.x = e.touches["0"].clientX; 
          touchStartPosition.y = e.touches["0"].clientY;
        }

        function touch(e){
          touchFrames += 1;
          var a = touchStartPosition.x - e.touches["0"].clientX; 
          var b = touchStartPosition.y - e.touches["0"].clientY;
          touchLength = Math.sqrt( a*a + b*b );
        }

        function touchEnd(e){
          touchLength = 0;
          touchFrames = 0;
          isTouching = false;
        }
      //

      //clicking
        var clickStartPosition = {
          x: 0,
          y: 0
        };
        var clickLength = 0;
        var isClicking = false;
        var clickFrames = 0;
        function clickDown(e){
          clickStartPosition.x = e.clientX;
          clickStartPosition.y = e.clientY;
          isClicking = true;
        }

        function click(e){
          if (isClicking) {
            clickFrames += 1;
            var a = clickStartPosition.x - e.clientX; 
            var b = clickStartPosition.y - e.clientY;
            clickLength = Math.sqrt( a*a + b*b );
          }
        }

        function clickUp(e){
          var a = touchStartPosition.x - e.clientX;  
          var b = touchStartPosition.y - e.clientY;
          clickLength = Math.sqrt( a*a + b*b );
          isClicking = false;
        }
      //
    //

    //floor    
      var floor = new PIXI.Graphics();
      var leftWall = new PIXI.Graphics();
      var rightWall = new PIXI.Graphics();
      function drawRoom(){
          floor.lineStyle(1, 0xffd900, 1);
          floor.moveTo(0, 900);
          floor.lineTo(1000, 900);
          floor.endFill();
          app.stage.addChild(floor);
          leftWall.lineStyle(2, 0xffd900, 1);
          leftWall.moveTo(100, 900);
          leftWall.lineTo(100, 100);
          leftWall.endFill();
          app.stage.addChild(leftWall);
          rightWall.lineStyle(2, 0xffd900, 1);
          rightWall.moveTo(700, 900);
          rightWall.lineTo(700, 100);
          rightWall.endFill();
          app.stage.addChild(rightWall);
        }
    //

    //player
      const player = new PIXI.Graphics();
      function drawPlayer(){
          player.beginFill(0xffd900);
          player.lineStyle(0);
          player.drawCircle(300, 800, 5);
          player.endFill();
          app.stage.addChild(player);
      }

      var moveSpeed = 7;
      var direction = 0;
      var gravity = 9.82;
      var jumpCount = 0;
      var playerOrigin = 0;
      var jumpSpeed = 0;
      const maxJumps = 2;
      const jumpHeight = 100;

      function toggleDirection(){
          moveSpeed = -moveSpeed;
      }
      function move(delta){
        var distanceFromLeftWall;
        distanceFromLeftWall = (player.getBounds().x - player.getBounds().width) - 
                              (rightWall.getBounds().x - rightWall.getBounds().width);
        
        var distanceFromRightWall;
        distanceFromRightWall = (rightWall.getBounds().x) - 
                            (player.getBounds().x);
        
        if (collides(player, leftWall) || collides(player, rightWall)) {
          toggleDirection();
        }
          player.x += moveSpeed * delta;
      }
    
      function fall(delta){
        var distanceFromFloor;
        distanceFromFloor = (floor.getBounds().y + floor.getBounds().height) - 
                            (player.getBounds().y + player.getBounds().height);
        if (collides(player, floor)) {
          jumpCount = 0;
        }else{
          if (distanceFromFloor < gravity){
            player.y += distanceFromFloor;
          }else{
            player.y += gravity * delta;
          }
        }
      }

      function jump(delta){
        player.y -= jumpSpeed * delta;
        if (isClicking || isTouching){
          if (jumpCount == 0) {
            jumpCount += 1;
            jumpSpeed = 16;
            playerOrigin = player.getBounds().y + player.getBounds().height;
          }

          if (jumpCount < 2){
              if (playerOrigin - (player.getBounds().y + player.getBounds().height) <= jumpHeight){
                jumpSpeed -= 0.5 * delta;
              }else{
                jumpCount = 2;
                if (jumpSpeed > 0) {
                  jumpSpeed -= 0.5 * delta;
                }else{
                  jumpSpeed = 0;
                }
              }
            }else{
              jumpCount = 2;
              if (jumpSpeed > 0) {
                jumpSpeed -= 0.5 * delta;
              }else{
                jumpSpeed = 0;
              }
            }
        }else {
          if (jumpSpeed > 0) {
            jumpSpeed -= 0.5 * delta;
          }else{
            jumpSpeed = 0;
          }
        }
      }

      function collides(a, b){
        var ab = a.getBounds();
        var bb = b.getBounds();
        return ab.x + ab.width > bb.x && ab.x < bb.x + bb.width && ab.y + ab.height > bb.y && ab.y < bb.y + bb.height;
      }
    //
  //
  </script>
<body>
  <script type="text/javascript">
    //load
      (function() {
        renderPortrait();
        drawRoom();
        drawPlayer();
        document.body.addEventListener('touchmove',  touch, false);
        document.body.addEventListener('touchstart',  touchStart, false);
        document.body.addEventListener('touchend',  touchEnd, false);

        document.body.addEventListener('clickhmove',  click, false);
        document.body.addEventListener('mousedown',  clickDown, false);
        document.body.addEventListener('mouseup',  clickUp, false);
      })();
    //

    //loop
      app.ticker.add(function(delta){
        fall(delta);
        move(delta);
        jump(delta);
      })
    //
  </script>
</body>
</html>
